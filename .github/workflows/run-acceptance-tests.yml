name: Run Acceptance Tests

on: push
#on: pull_request 
 

jobs:
  run-acceptance-tests:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      matrix:
        operating-system: [ubuntu-latest]
        php-versions: ['7.2']
        test-group: ['test_group_1', 'test_group_2', 'test_group_3']
      fail-fast: false
#    if: startsWith(github.head_ref, 'RC-') != false && endsWith(github.head_ref, '-major') != false  || endsWith(github.head_ref, '-minor') != false || endsWith(github.head_ref, '-patch') != false
    steps:
      - name: Checkout ${{ github.event.repository.name }}
        uses: wirecard/checkout@v2.0.0
        with:
          ref: ${{ github.head_ref }}
      - name: Checkout shopsystems-ui-test-runner
        uses: wirecard/checkout@v2.0.0
        with:
          repository: 'wirecard/shopsystems-ui-test-runner'
          ref: 'parallel_test_concept_2'
          path: shopsystems-ui-test-runner
      - name: PHP version setup
        uses: wirecard/setup-php@2.1.3
        with:
          php-version: ${{ matrix.php-versions }}
          extension: mbstring, intl, simplexml, dom
          ini-values: post_max_size=256M, short_open_tag=On
      - name: Extract ${{ github.event.repository.name }} version
        run: echo "::set-env name=SHOP_SYSTEM_VERSION::$(awk "NR==1 {print; exit}" ${SHOP_RELEASES_FILE})"
        env: 
          SHOP_RELEASES_FILE: '.bin/compatible-shop-releases.txt'
      - name: Set global git conf
        run: git config --global user.email "" && git config --global user.name "github-actions"
      - name: Run acceptance tests
        run: shopsystems-ui-test-runner/.bin/setup-and-run-ui-tests.sh
        shell: bash
        env:
          PHP_VERSION: ${{ matrix.php-versions }}
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BROWSERSTACK_USER: ${{ secrets.BROWSERSTACK_USER }}
          SHOP_SYSTEM_NAME: ${{ github.event.repository.name }}
          TEST_SUITE_BRANCH: parallel_test_concept_2
          NUMBER_OF_TEST_GROUPS: "3"
          TEST_GROUP: ${{ matrix.test-group}}
      - name: Acceptance tests passed
        if: ${{ success() }}
        run: shopsystems-ui-test-runner/.bin/upload-logs-and-notify.sh
        shell: bash
        env:
          SHOP_SYSTEM_NAME:  ${{ github.event.repository.name }}
          GIT_BRANCH: ${{ github.head_ref }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
      - name: Acceptance tests failed
        if: ${{ failure() }}
        run: shopsystems-ui-test-runner/.bin/upload-logs-and-notify.sh fail
        shell: bash
        env:
          SHOP_SYSTEM_NAME:  ${{ github.event.repository.name }}
          GIT_BRANCH: ${{ github.head_ref }}
          SLACK_ROOMS: ${{ secrets.SLACK_ROOMS }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
